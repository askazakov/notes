# –ö–∞–∫ —è —Å–æ–∑–¥–∞–≤–∞–ª generic-–æ–±—ä–µ–∫—Ç—ã, –Ω–µ –≤—ã–∑—ã–≤–∞—è —è–≤–Ω–æ –∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä 

## –ú–æ—Ç–∏–≤–∞—Ü–∏—è

–í –æ–¥–Ω–æ–º –∏–∑ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å–ª–æ–∂–∏–ª–∞—Å—å —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å IEvent, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∞—Å—Å–æ–≤, –µ–≥–æ —Ä–µ–∞–ª–∏–∑—É—é—â–∏—Ö,
–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–Ω–æ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å —ç—Ç–∏ –∏–≤–µ–Ω—Ç—ã –≤ generic-–∫–ª–∞—Å—Å ApplicationEvent:

```csharp
public interface IEvent {}

public record SomethingCreatedEvent : IEvent;

public record AnotherEvent : IEvent;

public interface INotification {}

public record ApplicationEvent<TEvent>(TEvent Event) : INotification where TEvent : IEvent;

public class Mapper { 
    public static INotification Map(IEvent evt) =>
        evt switch
        {
            SomethingCreatedEvent e => new ApplicationEvent<SomethingCreatedEvent>(e),
            AnotherEvent e => new ApplicationEvent<AnotherEvent>(e),
            _ => null
        };
}
```

–Ø –∑–∞—Ö–æ—Ç–µ–ª –Ω–µ –ø–æ–ø–æ–ª–Ω—è—Ç—å `switch` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `IEvent`,
–∞ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–æ ¬´—Å–∞–º–æ –∫–∞–∫-–Ω–∏–±—É–¥—å¬ª.

–î–µ–ª–∞—é –ø–æ–¥—Ö–æ–¥, –ø–æ–ª—É—á–∞—é:
```csharp
public static INotification Map(IEvent evt) =>
    Activator.CreateInstance(typeof(ApplicationEvent<>).MakeGenericType(evt.GetType()), evt) as INotification;
```

–ó–∞–¥–∞—é—Å—å –≤–æ–ø—Ä–æ—Å–æ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ. –ù–∞—Ö–æ–∂—É —Å—Ç–∞—Ç—å—é 
[Benchmarking 4 reflection methods for calling a constructor in .NET](https://andrewlock.net/benchmarking-4-reflection-methods-for-calling-a-constructor-in-dotnet/)
–æ—Ç Andrew Lock. –¢–∞–º —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ CompiledExpression —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –±—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ Activator (–±–µ–∑ —É—á—ë—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏
–∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Å–∞–º–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è)

–ü—Ä–æ–±—É—é

```shell
dotnet new -i BenchmarkDotNet.Templates
mkdir benchmark && cd "$_"
dotnet new benchmark -f net6.0 --console-app
```

—Å–æ —Å–ª–µ–¥—É—é—â–∏–º Benchmarks.cs

```csharp
namespace benchmark
{
    public interface IEvent {}

    public record SomethingCreatedEvent : IEvent;

    public interface INotification {}

    public record ApplicationEvent<TEvent>(TEvent Event) : INotification where TEvent : IEvent;

    public class Benchmarks
    {
        private readonly IEvent _somethingCreatedEvent = new SomethingCreatedEvent();
        private static readonly Type EventType = typeof(SomethingCreatedEvent);

        private static readonly Delegate CompiledExpressionForGeneric = MakeExpression(EventType);
        private static readonly Type ApplicationEventType =
            typeof(ApplicationEvent<>).MakeGenericType(EventType);

        private static Delegate MakeExpression(Type type)
        {
            var apEventType = typeof(ApplicationEvent<>).MakeGenericType(type);
            var constructorInfos = apEventType.GetConstructor(new[] { type });
            var arg = Expression.Parameter(type, "Event");

            var constructorExpression = Expression.New(constructorInfos, arg);
            return Expression.Lambda(constructorExpression, arg).Compile();
        }

        [Benchmark(Baseline = true)]
        public INotification CreateViaCtor() =>
            new ApplicationEvent<SomethingCreatedEvent>((SomethingCreatedEvent)_somethingCreatedEvent);

        [Benchmark]
        public INotification CreateViaActivator() =>
            Activator.CreateInstance(ApplicationEventType, _somethingCreatedEvent) as INotification;

        [Benchmark]
        public INotification CreateViaExpression() =>
            CompiledExpressionForGeneric.DynamicInvoke(_somethingCreatedEvent) as INotification;
    }
}
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
``` ini
BenchmarkDotNet=v0.12.1, OS=macOS 12.6.2 (21G320) [Darwin 21.6.0]
Intel Core i5-8259U CPU 2.30GHz (Coffee Lake), 1 CPU, 8 logical and 4 physical cores
.NET Core SDK=6.0.402
  [Host]     : .NET Core 6.0.10 (CoreCLR 6.0.1022.47605, CoreFX 6.0.1022.47605), X64 RyuJIT
  DefaultJob : .NET Core 6.0.10 (CoreCLR 6.0.1022.47605, CoreFX 6.0.1022.47605), X64 RyuJIT
```

|              Method |       Mean |     Error |    StdDev | Ratio | RatioSD |
|-------------------- |-----------:|----------:|----------:|------:|--------:|
|       CreateViaCtor |   8.383 ns | 0.1117 ns | 0.0872 ns |  1.00 |    0.00 |
|  CreateViaActivator | 523.390 ns | 3.1727 ns | 2.6494 ns | 62.43 |    0.71 |
| CreateViaExpression | 528.583 ns | 4.2310 ns | 3.7506 ns | 63.01 |    0.81 |

ü§î ‚Äì –≤—ã—Ö–æ–¥–∏—Ç, —á—Ç–æ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É —Å–æ–∑–¥–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ –∞–∫—Ç–∏–≤–∞—Ç–æ—Ä –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –æ—Å–æ–±–æ –Ω–µ—Ç.

–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é, —á—Ç–æ –±—ã–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–±—É—é –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –æ—Ç Andrew:

```csharp
    public class Benchmarks
    {
        private static readonly Type EventType = typeof(SomethingCreatedEvent);

        private static readonly Func<SomethingCreatedEvent> CreateEventExpression =
            Expression.Lambda<Func<SomethingCreatedEvent>>(Expression.New(EventType)).Compile();  

        [Benchmark(Baseline = true)]
        public IEvent CreateEventViaCtor() => new SomethingCreatedEvent();

        [Benchmark]
        public IEvent CreateEventViaActivator() => Activator.CreateInstance(EventType) as IEvent;

        [Benchmark]
        public IEvent CreateEventViaExpression() => CreateEventExpression.Invoke();
    }
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã 

|                   Method |      Mean |     Error |    StdDev | Ratio | RatioSD |
|------------------------- |----------:|----------:|----------:|------:|--------:|
|       CreateEventViaCtor |  5.367 ns | 0.0957 ns | 0.0895 ns |  1.00 |    0.00 |
|  CreateEventViaActivator | 14.607 ns | 0.0932 ns | 0.0826 ns |  2.72 |    0.06 |
| CreateEventViaExpression |  6.014 ns | 0.0686 ns | 0.0642 ns |  1.12 |    0.02 |

–°—Ö–æ–¥–∏—Ç—Å—è, –∑–Ω–∞—á–∏—Ç, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ generic-–∫–ª–∞—Å—Å–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á—Ç–æ-—Ç–æ –æ—Å–æ–±–æ–µ, —á—Ç–æ –Ω–∏–≤–µ–ª–∏—Ä—É–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–∞—Ç–æ—Ä–æ–º –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º.

–ü—Ä–∏ —ç—Ç–æ–º –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤ 60 —Ä–∞–∑ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ–Ω—è –∑–∞—Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ —è —Ö–æ—á—É –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —è–≤–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è ApplicationEvent

upd –æ—Ç 2023.01.30:

–ü–æ –Ω–∞–≤–æ–¥–∫–µ –æ—Ç [@Pliner](https://github.com/Pliner) –ø–æ—Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª https://github.com/EasyNetQ/EasyNetQ/pull/1519 –∏ –ø–æ–Ω—è–ª, —á—Ç–æ –¥–µ–ª–∞—é –Ω–µ —Ç–∞–∫: DynamicInvoke —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –ù–µ –Ω–∞–¥–æ –ø—ã—Ç–∞—Ç—å—Å—è —Å–¥–µ–ª–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Äì —Ç–∞–∫ –∫–∞–∫ —Ç–∏–ø —ç—Ç–æ—Ç –±—É–¥–µ—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ, –º—ã –Ω–µ –º–æ–∂–µ–º –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ DynamicInvoke, –∞ –µ—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–µ object, —Ç–æ –≤—Å—ë —Å–æ–π–¥—ë—Ç—Å—è:

–∫–æ–¥

```csharp
private static Func<object, INotification> MakeParameterizedLambdaExpression(Type type)
{
    var applicationEventType = typeof(ApplicationEvent<>).MakeGenericType(type);
    var constructorInfo = applicationEventType.GetConstructor(new[] { type });
    var ctorArg = Expression.Parameter(typeof(object), "Event"); // <- –∑–¥–µ—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞

    var constructorExpression = Expression.New(
        constructorInfo,
        Expression.Convert(ctorArg, type) // <- –∑–¥–µ—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    );
    return Expression
        .Lambda<Func<object, INotification>>(constructorExpression, ctorArg)  // <- –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è Lambda
        .Compile();
}

public static readonly Func<object, INotification> CompiledParameterizedExpression =
    MakeParameterizedLambdaExpression(EventType);

// 
[Benchmark]
public INotification CreateViaCompiledParameterizedExpression() =>
    CompiledParameterizedExpression.Invoke(_somethingCreatedEvent);

[Benchmark]
public INotification CreateViaCompiledParameterizedExpressionWithDynamicInvoke() =>
    CompiledParameterizedExpression.DynamicInvoke(_somethingCreatedEvent) as INotification;
```

–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

``` ini

BenchmarkDotNet=v0.12.1, OS=macOS 12.6.2 (21G320) [Darwin 21.6.0]
Intel Core i5-8259U CPU 2.30GHz (Coffee Lake), 1 CPU, 8 logical and 4 physical cores
.NET Core SDK=6.0.402
  [Host]     : .NET Core 6.0.10 (CoreCLR 6.0.1022.47605, CoreFX 6.0.1022.47605), X64 RyuJIT
  DefaultJob : .NET Core 6.0.10 (CoreCLR 6.0.1022.47605, CoreFX 6.0.1022.47605), X64 RyuJIT
```
|                                                    Method |       Mean |     Error |     StdDev | Ratio | RatioSD |
|---------------------------------------------------------- |-----------:|----------:|-----------:|------:|--------:|
|                                             CreateViaCtor |   7.314 ns | 0.0606 ns |  0.0537 ns |  1.00 |    0.00 |
|                                       CreateViaExpression | 482.540 ns | 9.3683 ns | 12.1814 ns | 65.75 |    1.59 |
|                  CreateViaCompiledParameterizedExpression |   8.352 ns | 0.1674 ns |  0.1566 ns |  1.14 |    0.02 |
| CreateViaCompiledParameterizedExpressionWithDynamicInvoke | 507.757 ns | 2.4929 ns |  2.2099 ns | 69.43 |    0.57 |

–í–∏–¥–Ω–æ, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã–∑—ã–≤–∞–µ–º–æ–µ —á–µ—Ä–µ–∑ `Invoke`, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ —É—Å—Ç—É–ø–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—é —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.

–ù–æ –µ—Å–ª–∏ –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DynamicInvoke, —Ç–æ —Å–Ω–æ–≤–∞ –≤—Å—ë –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ç—ã–∫–≤—É.